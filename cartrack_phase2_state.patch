From 8b76b60419961c8338f89b78c3e4d1204a43566b Mon Sep 17 00:00:00 2001
From: lozigit <nick@inventoryguardian.co.uk>
Date: Fri, 6 Feb 2026 18:17:05 +0000
Subject: [PATCH] Minor tweaks to the UI

---
 frontend/src/lib/api.ts          |  84 +++++++++---
 frontend/src/lib/ui.tsx          |   2 +
 frontend/src/pages/CarDetail.tsx | 227 ++++++++++++++++++++++++++-----
 package-lock.json                |   6 +
 4 files changed, 269 insertions(+), 50 deletions(-)
 create mode 100644 package-lock.json

diff --git a/frontend/src/lib/api.ts b/frontend/src/lib/api.ts
index 2efdb3d..9cd4d27 100644
--- a/frontend/src/lib/api.ts
+++ b/frontend/src/lib/api.ts
@@ -1,7 +1,10 @@
 const API_BASE = import.meta.env.VITE_API_BASE ?? "http://localhost:8000";
 
+// This file contains functions for making API requests to the backend, as well as TypeScript types for the data structures used in those requests and responses.
+// The goal is to centralize all API-related code here, so that the rest of the app can just import and use these functions without worrying about the details of the API endpoints or request formatting.
 export type TokenResponse = { access_token: string; token_type: string };
 
+// Types for the main data structures used in the app, based on the backend API
 export type Car = {
   id: string;
   household_id: string;
@@ -65,6 +68,7 @@ export function setToken(token: string | null) {
   else localStorage.removeItem("cartrack_token");
 }
 
+// Helper function to make API requests with proper headers and error handling
 async function request<T>(path: string, opts: RequestInit = {}): Promise<T> {
   const token = getToken();
   const headers: Record<string, string> = {
@@ -74,11 +78,14 @@ async function request<T>(path: string, opts: RequestInit = {}): Promise<T> {
   if (token) headers["Authorization"] = `Bearer ${token}`;
 
   const res = await fetch(`${API_BASE}${path}`, { ...opts, headers });
-  const isJson = (res.headers.get("content-type") ?? "").includes("application/json");
+  const isJson = (res.headers.get("content-type") ?? "").includes(
+    "application/json",
+  );
   const body = isJson ? await res.json() : await res.text();
 
   if (!res.ok) {
-    const msg = typeof body === "string" ? body : (body?.detail ?? "Request failed");
+    const msg =
+      typeof body === "string" ? body : (body?.detail ?? "Request failed");
     throw new Error(msg);
   }
   return body as T;
@@ -87,35 +94,78 @@ async function request<T>(path: string, opts: RequestInit = {}): Promise<T> {
 export const api = {
   // auth
   signup: (email: string, password: string) =>
-    request("/api/auth/signup", { method: "POST", body: JSON.stringify({ email, password }) }),
+    request("/api/auth/signup", {
+      method: "POST",
+      body: JSON.stringify({ email, password }),
+    }),
   login: (email: string, password: string) =>
-    request<TokenResponse>("/api/auth/login", { method: "POST", body: JSON.stringify({ email, password }) }),
+    request<TokenResponse>("/api/auth/login", {
+      method: "POST",
+      body: JSON.stringify({ email, password }),
+    }),
 
   // household
   createHousehold: (name: string) =>
-    request("/api/households", { method: "POST", body: JSON.stringify({ name }) }),
+    request("/api/households", {
+      method: "POST",
+      body: JSON.stringify({ name }),
+    }),
   getCurrentHousehold: () => request("/api/households/current"),
 
   // cars
   listCars: (includeArchived = false) =>
-    request<Car[]>(`/api/cars?include_archived=${includeArchived ? "true" : "false"}`),
-  createCar: (payload: { registration_number: string; make?: string; model?: string }) =>
-    request<Car>("/api/cars", { method: "POST", body: JSON.stringify(payload) }),
+    request<Car[]>(
+      `/api/cars?include_archived=${includeArchived ? "true" : "false"}`,
+    ),
+  createCar: (payload: {
+    registration_number: string;
+    make?: string;
+    model?: string;
+  }) =>
+    request<Car>("/api/cars", {
+      method: "POST",
+      body: JSON.stringify(payload),
+    }),
   getCar: (id: string) => request<Car>(`/api/cars/${id}`),
-  updateCar: (id: string, payload: any) => request<Car>(`/api/cars/${id}`, { method: "PATCH", body: JSON.stringify(payload) }),
-  archiveCar: (id: string) => request<Car>(`/api/cars/${id}/archive`, { method: "POST" }),
-  unarchiveCar: (id: string) => request<Car>(`/api/cars/${id}/unarchive`, { method: "POST" }),
+  updateCar: (id: string, payload: any) =>
+    request<Car>(`/api/cars/${id}`, {
+      method: "PATCH",
+      body: JSON.stringify(payload),
+    }),
+  archiveCar: (id: string) =>
+    request<Car>(`/api/cars/${id}/archive`, { method: "POST" }),
+  unarchiveCar: (id: string) =>
+    request<Car>(`/api/cars/${id}/unarchive`, { method: "POST" }),
 
   // renewals
+  // get a renewal by ID (used for editing)
+  getRenewal: (id: string) => request<RenewalOut>(`/api/renewals/${id}`),
+  // update a renewal by ID
+  updateRenewal: (id: string, payload: Partial<RenewalCreate>) =>
+    request<RenewalOut>(`/api/renewals/${id}`, {
+      method: "PATCH",
+      body: JSON.stringify(payload),
+    }),
   listRenewals: (carId: string, kind?: RenewalKind) =>
-    request<RenewalOut[]>(`/api/cars/${carId}/renewals${kind ? `?kind=${kind}` : ""}`),
+    request<RenewalOut[]>(
+      `/api/cars/${carId}/renewals${kind ? `?kind=${kind}` : ""}`,
+    ),
   createRenewal: (carId: string, payload: RenewalCreate) =>
-    request<RenewalOut>(`/api/cars/${carId}/renewals`, { method: "POST", body: JSON.stringify(payload) }),
-  deleteRenewal: (renewalId: string) => request<void>(`/api/renewals/${renewalId}`, { method: "DELETE" }),
-  upcomingRenewals: (days = 60) => request<UpcomingRenewalOut[]>(`/api/renewals/upcoming?days=${days}`),
+    request<RenewalOut>(`/api/cars/${carId}/renewals`, {
+      method: "POST",
+      body: JSON.stringify(payload),
+    }),
+  deleteRenewal: (renewalId: string) =>
+    request<void>(`/api/renewals/${renewalId}`, { method: "DELETE" }),
+  upcomingRenewals: (days = 60) =>
+    request<UpcomingRenewalOut[]>(`/api/renewals/upcoming?days=${days}`),
 
   // settings
-  getReminderPreferences: () => request<ReminderPreferences>("/api/settings/reminders"),
+  getReminderPreferences: () =>
+    request<ReminderPreferences>("/api/settings/reminders"),
   saveReminderPreferences: (prefs: ReminderPreferences) =>
-    request<ReminderPreferences>("/api/settings/reminders", { method: "PUT", body: JSON.stringify(prefs) }),
+    request<ReminderPreferences>("/api/settings/reminders", {
+      method: "PUT",
+      body: JSON.stringify(prefs),
+    }),
 };
diff --git a/frontend/src/lib/ui.tsx b/frontend/src/lib/ui.tsx
index 94d8e0a..f20b55e 100644
--- a/frontend/src/lib/ui.tsx
+++ b/frontend/src/lib/ui.tsx
@@ -1,5 +1,7 @@
 import React from "react";
 
+// This file contains simple reusable UI components used across the app, like cards, buttons, inputs, etc.
+// They are intentionally very basic and unstyled, just to provide some consistent structure and spacing without relying on external libraries or complex CSS.
 export function Card(props: { title: string; children: React.ReactNode }) {
   return (
     <div style={{ border: "1px solid #ddd", borderRadius: 12, padding: 16, marginBottom: 16 }}>
diff --git a/frontend/src/pages/CarDetail.tsx b/frontend/src/pages/CarDetail.tsx
index 629863c..37deac3 100644
--- a/frontend/src/pages/CarDetail.tsx
+++ b/frontend/src/pages/CarDetail.tsx
@@ -25,32 +25,51 @@ function parseDate(s?: string | null): Date | null {
   return Number.isNaN(d.getTime()) ? null : d;
 }
 
+// Determine the status for a list of renewals of a given kind, e.g. insurance policies.
+// The "current" one is the one whose valid_from/valid_to range includes today (if any).
+// If the current one expires within 7 days, it's a warning; if it expired in the past, it's bad; otherwise it's good.
 function statusForKind(rows: RenewalOut[]) {
   const today = new Date();
   const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());
   const current = rows.find((r) => {
     const from = parseDate(r.valid_from);
     const to = parseDate(r.valid_to);
+
+    // If either date is invalid, treat as not current (could also treat as always current, but this seems safer)
     if (!from || !to) return false;
+    // Check if today is within the valid range (inclusive)
     return from <= t && t <= to;
   });
+  // If there's a current one, check how soon it expires
   if (current) {
     const to = parseDate(current.valid_to)!;
-    const days = Math.ceil((to.getTime() - t.getTime()) / (1000 * 60 * 60 * 24));
+    const renewal_type = labelFor(current.kind);
+    const days = Math.ceil(
+      (to.getTime() - t.getTime()) / (1000 * 60 * 60 * 24),
+    );
     const tone = days <= 7 ? "warn" : "good";
-    return { text: `Current (${days}d left)`, tone } as const;
+    // If it expires within 7 days, show a warning; otherwise it's good
+    // Add renewal kind and provider to the text if available, e.g. "Insurance (Acme Co, 5d left)"
+
+    return { text: `${renewal_type} is valid. There are ${days} days left`, tone } as const;
   }
+  // No current one, check if the most recent one expired in the past
   const mostRecent = rows[0];
   if (mostRecent) {
     const to = parseDate(mostRecent.valid_to);
     if (to && to < t) {
-      const days = Math.ceil((t.getTime() - to.getTime()) / (1000 * 60 * 60 * 24));
+      const days = Math.ceil(
+        (t.getTime() - to.getTime()) / (1000 * 60 * 60 * 24),
+      );
+      // Expired in the past, show how many days ago it expired
       return { text: `Expired (${days}d ago)`, tone: "bad" } as const;
     }
   }
+  // No current one and none expired in the past, so it's just missing
   return { text: "Missing", tone: "bad" } as const;
 }
 
+// The main page for a single car, showing its details and renewal records.
 export default function CarDetail() {
   const { id } = useParams();
   const [car, setCar] = useState<Car | null>(null);
@@ -68,9 +87,33 @@ export default function CarDetail() {
   });
 
   const [forms, setForms] = useState<Record<RenewalKind, RenewalCreate>>({
-    INSURANCE: { kind: "INSURANCE", valid_from: iso(new Date()), valid_to: iso(new Date()), provider: null, reference: null, cost_pence: null, notes: null },
-    MOT: { kind: "MOT", valid_from: iso(new Date()), valid_to: iso(new Date()), provider: null, reference: null, cost_pence: null, notes: null },
-    TAX: { kind: "TAX", valid_from: iso(new Date()), valid_to: iso(new Date()), provider: null, reference: null, cost_pence: null, notes: null },
+    INSURANCE: {
+      kind: "INSURANCE",
+      valid_from: iso(new Date()),
+      valid_to: iso(new Date()),
+      provider: null,
+      reference: null,
+      cost_pence: null,
+      notes: null,
+    },
+    MOT: {
+      kind: "MOT",
+      valid_from: iso(new Date()),
+      valid_to: iso(new Date()),
+      provider: null,
+      reference: null,
+      cost_pence: null,
+      notes: null,
+    },
+    TAX: {
+      kind: "TAX",
+      valid_from: iso(new Date()),
+      valid_to: iso(new Date()),
+      provider: null,
+      reference: null,
+      cost_pence: null,
+      notes: null,
+    },
   });
 
   async function load() {
@@ -83,15 +126,25 @@ export default function CarDetail() {
       setMake(c.make ?? "");
       setModel(c.model ?? "");
 
-      const lists = await Promise.all(kinds.map((k) => api.listRenewals(id, k).catch(() => [] as RenewalOut[])));
-      const next: Record<RenewalKind, RenewalOut[]> = { INSURANCE: lists[0], MOT: lists[1], TAX: lists[2] };
+      const lists = await Promise.all(
+        kinds.map((k) =>
+          api.listRenewals(id, k).catch(() => [] as RenewalOut[]),
+        ),
+      );
+      const next: Record<RenewalKind, RenewalOut[]> = {
+        INSURANCE: lists[0],
+        MOT: lists[1],
+        TAX: lists[2],
+      };
       setRenewals(next);
     } catch (e: any) {
       setErr(e.message ?? "Failed to load car");
     }
   }
 
-  useEffect(() => { load(); }, [id]);
+  useEffect(() => {
+    load();
+  }, [id]);
 
   const status = useMemo(() => {
     return {
@@ -125,7 +178,9 @@ export default function CarDetail() {
     setBusy(true);
     setErr(null);
     try {
-      const updated = car.is_archived ? await api.unarchiveCar(id) : await api.archiveCar(id);
+      const updated = car.is_archived
+        ? await api.unarchiveCar(id)
+        : await api.archiveCar(id);
       setCar(updated);
     } catch (e: any) {
       setErr(e.message ?? "Failed to update archive status");
@@ -166,24 +221,42 @@ export default function CarDetail() {
 
   return (
     <>
-      <Card title="Car detail">
-        <div style={{ marginBottom: 12 }}><Link to="/">&larr; Back to dashboard</Link></div>
+      <Card title="Car details">
+        <div style={{ marginBottom: 12 }}>
+          <Link to="/">&larr; Back to dashboard</Link>
+        </div>
         {err && <div style={{ color: "crimson", marginBottom: 12 }}>{err}</div>}
         {!car ? (
           <div>Loading...</div>
         ) : (
           <>
-            <div style={{ display: "flex", gap: 10, alignItems: "center", marginBottom: 12 }}>
-              <div>Status: <b>{car.is_archived ? "Archived" : "Active"}</b></div>
+            <div
+              style={{
+                display: "flex",
+                gap: 10,
+                alignItems: "center",
+                marginBottom: 12,
+              }}
+            >
+              <div>
+                Status: <b>{car.is_archived ? "Archived" : "Active"}</b>
+              </div>
               <Pill text={status.INSURANCE.text} tone={status.INSURANCE.tone} />
               <Pill text={status.MOT.text} tone={status.MOT.tone} />
               <Pill text={status.TAX.text} tone={status.TAX.tone} />
             </div>
 
-            <form onSubmit={saveCar} style={{ display: "grid", gap: 12, maxWidth: 520 }}>
+            <form
+              onSubmit={saveCar}
+              style={{ display: "grid", gap: 12, maxWidth: 520 }}
+            >
               <label>
                 VRM
-                <Input value={vrm} onChange={(e) => setVrm(e.target.value)} required />
+                <Input
+                  value={vrm}
+                  onChange={(e) => setVrm(e.target.value)}
+                  required
+                />
               </label>
               <label>
                 Make
@@ -191,11 +264,16 @@ export default function CarDetail() {
               </label>
               <label>
                 Model
-                <Input value={model} onChange={(e) => setModel(e.target.value)} />
+                <Input
+                  value={model}
+                  onChange={(e) => setModel(e.target.value)}
+                />
               </label>
 
               <div style={{ display: "flex", gap: 12 }}>
-                <Button disabled={busy} type="submit">{busy ? "Saving..." : "Save"}</Button>
+                <Button disabled={busy} type="submit">
+                  {busy ? "Saving..." : "Save"}
+                </Button>
                 <Button disabled={busy} type="button" onClick={toggleArchive}>
                   {car.is_archived ? "Unarchive" : "Archive"}
                 </Button>
@@ -207,54 +285,135 @@ export default function CarDetail() {
 
       <Card title="Renewals">
         <p style={{ marginTop: 0, opacity: 0.8 }}>
-          Add renewal records over time. The app will treat the record whose date range includes today as the <b>current</b> one.
+          Add renewal records over time. The app will treat the record whose
+          date range includes today as the <b>current</b> one.
         </p>
 
         {kinds.map((k) => (
-          <div key={k} style={{ borderTop: "1px solid #eee", paddingTop: 12, marginTop: 12 }}>
-            <h3 style={{ margin: "0 0 8px 0", display: "flex", alignItems: "center", gap: 10 }}>
+          <div
+            key={k}
+            style={{
+              borderTop: "1px solid #eee",
+              paddingTop: 12,
+              marginTop: 12,
+            }}
+          >
+            <h3
+              style={{
+                margin: "0 0 8px 0",
+                display: "flex",
+                alignItems: "center",
+                gap: 10,
+              }}
+            >
               {labelFor(k)} <Pill text={status[k].text} tone={status[k].tone} />
             </h3>
 
-            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, maxWidth: 720 }}>
+            <div
+              style={{
+                display: "grid",
+                gridTemplateColumns: "1fr 1fr",
+                gap: 12,
+                maxWidth: 720,
+              }}
+            >
               <label>
                 Valid from
-                <Input type="date" value={forms[k].valid_from} onChange={(e) => setForms({ ...forms, [k]: { ...forms[k], valid_from: e.target.value } })} />
+                <Input
+                  type="date"
+                  value={forms[k].valid_from}
+                  onChange={(e) =>
+                    setForms({
+                      ...forms,
+                      [k]: { ...forms[k], valid_from: e.target.value },
+                    })
+                  }
+                />
               </label>
               <label>
                 Valid to
-                <Input type="date" value={forms[k].valid_to} onChange={(e) => setForms({ ...forms, [k]: { ...forms[k], valid_to: e.target.value } })} />
+                <Input
+                  type="date"
+                  value={forms[k].valid_to}
+                  onChange={(e) =>
+                    setForms({
+                      ...forms,
+                      [k]: { ...forms[k], valid_to: e.target.value },
+                    })
+                  }
+                />
               </label>
               <label>
                 Provider (optional)
-                <Input value={forms[k].provider ?? ""} onChange={(e) => setForms({ ...forms, [k]: { ...forms[k], provider: e.target.value || null } })} />
+                <Input
+                  value={forms[k].provider ?? ""}
+                  onChange={(e) =>
+                    setForms({
+                      ...forms,
+                      [k]: { ...forms[k], provider: e.target.value || null },
+                    })
+                  }
+                />
               </label>
               <label>
                 Reference (optional)
-                <Input value={forms[k].reference ?? ""} onChange={(e) => setForms({ ...forms, [k]: { ...forms[k], reference: e.target.value || null } })} />
+                <Input
+                  value={forms[k].reference ?? ""}
+                  onChange={(e) =>
+                    setForms({
+                      ...forms,
+                      [k]: { ...forms[k], reference: e.target.value || null },
+                    })
+                  }
+                />
               </label>
               <label>
-                Cost (pence, optional)
+                Cost (pounds, optional)
                 <Input
                   inputMode="numeric"
                   value={forms[k].cost_pence?.toString() ?? ""}
                   onChange={(e) => {
                     const v = e.target.value.trim();
-                    setForms({ ...forms, [k]: { ...forms[k], cost_pence: v ? Number(v) : null } });
+                    setForms({
+                      ...forms,
+                      [k]: { ...forms[k], cost_pence: v ? Number(v) : null },
+                    });
                   }}
                 />
               </label>
               <div />
               <label style={{ gridColumn: "1 / -1" }}>
                 Notes (optional)
-                <Textarea value={forms[k].notes ?? ""} onChange={(e) => setForms({ ...forms, [k]: { ...forms[k], notes: e.target.value || null } })} />
+                <Textarea
+                  value={forms[k].notes ?? ""}
+                  onChange={(e) =>
+                    setForms({
+                      ...forms,
+                      [k]: { ...forms[k], notes: e.target.value || null },
+                    })
+                  }
+                />
               </label>
 
-              <div style={{ gridColumn: "1 / -1", display: "flex", gap: 12, alignItems: "center" }}>
-                <Button disabled={busy} type="button" onClick={() => addRenewal(k)}>
+              <div
+                style={{
+                  gridColumn: "1 / -1",
+                  display: "flex",
+                  gap: 12,
+                  alignItems: "center",
+                }}
+              >
+                <Button
+                  disabled={busy}
+                  type="button"
+                  onClick={() => addRenewal(k)}
+                >
                   {busy ? "Working..." : "Add renewal"}
                 </Button>
-                <span style={{ opacity: 0.7, fontSize: 12 }}>Tip: for one-year policies, set valid_to 12 months after valid_from.</span>
+                <span style={{ opacity: 0.7, fontSize: 12 }}>
+                  Tip: for one-year policies, set valid_to 12 months after
+                  valid_from.
+                </span>
               </div>
             </div>
 
@@ -268,7 +427,9 @@ export default function CarDetail() {
                     <li key={r.id} style={{ marginBottom: 6 }}>
                       {r.valid_from} → {r.valid_to}
                       {r.provider ? ` — ${r.provider}` : ""}
-                      {typeof r.cost_pence === "number" ? ` — £${(r.cost_pence / 100).toFixed(2)}` : ""}
+                      {typeof r.cost_pence === "number"
+                        ? ` — £${(r.cost_pence / 100).toFixed(2)}`
+                        : ""}
                       <Button
                         disabled={busy}
                         type="button"
diff --git a/package-lock.json b/package-lock.json
new file mode 100644
index 0000000..47e421e
--- /dev/null
+++ b/package-lock.json
@@ -0,0 +1,6 @@
+{
+  "name": "Car_Tracker",
+  "lockfileVersion": 3,
+  "requires": true,
+  "packages": {}
+}
-- 
2.47.0.windows.1

